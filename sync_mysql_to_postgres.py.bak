import os
from sqlalchemy import create_engine, MetaData, Table
from sqlalchemy.orm import sessionmaker
import pymysql
import psycopg2

# ------------------------
# CONFIGURA√á√ÉO DOS BANCOS
# ------------------------

# MySQL local
MYSQL_USER = "root"
MYSQL_PASSWORD = "SUA_SENHA_MYSQL"
MYSQL_HOST = "localhost"
MYSQL_DB = "estetica_cloud"

# PostgreSQL Render
POSTGRES_URL = os.getenv(
    "DATABASE_URL",
    "postgresql://db_a3m8_user:9Kkk9oPT6VRTounXRgpYdrueRxEa94fi@dpg-d47r22c9c44c73ccebcg-a.oregon-postgres.render.com/db_a3m8"
)

# ------------------------
# CONEX√ïES
# ------------------------

# MySQL
mysql_engine = create_engine(f"mysql+pymysql://{MYSQL_USER}:{MYSQL_PASSWORD}@{MYSQL_HOST}/{MYSQL_DB}")
mysql_conn = mysql_engine.connect()
mysql_meta = MetaData(bind=mysql_engine)
mysql_meta.reflect()

# PostgreSQL
pg_engine = create_engine(POSTGRES_URL)
pg_conn = pg_engine.connect()
pg_meta = MetaData(bind=pg_engine)

# Cria tabelas no PostgreSQL se n√£o existirem
for table_name in mysql_meta.tables:
    table = Table(table_name, mysql_meta, autoload_with=mysql_engine)
    table.metadata.create_all(pg_engine)

# ------------------------
# SINCRONIZA√á√ÉO DADOS
# ------------------------

for table_name, table_obj in mysql_meta.tables.items():
    print(f"‚è≥ Sincronizando tabela: {table_name}")
    # Seleciona todos os dados do MySQL
    result = mysql_conn.execute(table_obj.select())
    rows = [dict(r) for r in result]
    if rows:
        pg_conn.execute(table_obj.insert(), rows)
    print(f"‚úÖ {len(rows)} registros inseridos em {table_name}")

print("üéâ Sincroniza√ß√£o completa!")
mysql_conn.close()
pg_conn.close()
